<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MakeHive - Cart</title>
<style>
  body { font-family: Arial; padding: 20px; }
  .product { display:flex; align-items:center; gap:15px; margin-bottom:10px; }
  .remove-btn { background:#ff4d4f; color:white; border:none; padding:5px 10px; cursor:pointer; }
  .qr-box { border:1px solid #ccc; padding:10px; margin-top:15px; }
</style>
</head>
<body>
<h1>Your Cart</h1>
<div id="cart-products"></div>
<p><strong>Total:</strong> ₹<span id="total-amount">0</span></p>
<div id="cart-qrcodes"></div>

<script>
const cartProductsDiv=document.getElementById("cart-products");
const cartQRCodesDiv=document.getElementById("cart-qrcodes");
const totalAmountSpan=document.getElementById("total-amount");
let productsInCart=[];

function getToken(){const token=localStorage.getItem("token"); if(!token) alert("⚠️ You must log in first"); return token;}

async function loadCart(){
  const token=getToken(); if(!token) return;
  try{
    const res=await fetch("http://localhost:5000/api/cart",{headers:{Authorization:`Bearer ${token}`}});
    if(!res.ok) throw new Error("Unauthorized or failed request");
    productsInCart=await res.json();
    if(!productsInCart.length) cartProductsDiv.innerHTML="<p>Cart is empty</p>";
    renderProducts(); updateQRCodes();
  }catch(err){console.error(err); cartProductsDiv.innerHTML="<p>Failed to load cart</p>";}
}

function renderProducts(){
  cartProductsDiv.innerHTML="";
  productsInCart.forEach(p=>{
    const div=document.createElement("div");
    div.classList.add("product");
    div.innerHTML=`<input type="checkbox" data-id="${p._id}" checked>
      <img src="${p.image||'images/default-banner.jpg'}" width="80">
      <div><p>${p.name}</p><p>₹${p.price}</p></div>
      <button class="remove-btn" data-id="${p._id}">Remove</button>`;
    cartProductsDiv.appendChild(div);
  });
  document.querySelectorAll(".remove-btn").forEach(btn=>btn.addEventListener("click",removeProduct));
  document.querySelectorAll("#cart-products input").forEach(input=>input.addEventListener("change",updateQRCodes));
}

async function removeProduct(e){
  const id=e.target.dataset.id;
  const token=getToken(); if(!token) return;
  try{
    const res=await fetch(`http://localhost:5000/api/cart/${id}`,{method:"DELETE",headers:{Authorization:`Bearer ${token}`}});
    if(!res.ok) throw new Error("Failed to remove product");
    productsInCart=productsInCart.filter(p=>p._id!==id);
    renderProducts(); updateQRCodes();
  }catch(err){console.error(err);}
}

async function updateQRCodes(){
  const token=getToken(); if(!token) return;
  const selectedIds=Array.from(document.querySelectorAll("#cart-products input:checked")).map(i=>i.dataset.id);
  let total=0; selectedIds.forEach(id=>{const prod=productsInCart.find(p=>p._id===id); if(prod) total+=prod.price;});
  totalAmountSpan.textContent=total;
  if(!selectedIds.length){cartQRCodesDiv.innerHTML="<p>No products selected</p>"; return;}
  try{
    const res=await fetch("http://localhost:5000/api/upi",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({products:selectedIds})});
    if(!res.ok) throw new Error("Failed to fetch QR codes");
    const data=await res.json();
    cartQRCodesDiv.innerHTML="";
    data.forEach(s=>{
      const div=document.createElement("div");
      div.classList.add("qr-box");
      div.innerHTML=`<h3>${s.sellerName} - ₹${s.total}</h3>
        <img src="${s.qrCode}" width="150">
        <ul>${s.products.map(p=>`<li>${p.name} - ₹${p.price}</li>`).join("")}</ul>`;
      cartQRCodesDiv.appendChild(div);
    });
  }catch(err){console.error(err); cartQRCodesDiv.innerHTML="<p>Failed to load QR codes</p>";}
}

loadCart();
</script>
</body>
</html>
